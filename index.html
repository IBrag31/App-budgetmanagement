<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Budget</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {font-family:-apple-system;background:#0f172a;color:white;padding:20px;}
.card {background:#1e293b;padding:15px;border-radius:16px;margin-bottom:20px;}
input {width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
button {padding:10px;border:none;border-radius:8px;background:#22c55e;color:white;}
table {width:100%;margin-top:10px;border-collapse:collapse;}
th,td {padding:6px;text-align:center;}
.progress {background:#334155;border-radius:20px;height:15px;}
.progress-bar {height:100%;background:#22c55e;width:0%;}
</style>
</head>
<body>

<h1>ðŸ’° Mon Budget</h1>

<div class="card">
<h3>Budget</h3>

Revenus
<input type="number" id="revenus" value="1971">

Charges fixes
<input type="number" id="charges" value="812">

Courses
<input type="number" id="courses" value="0">

Essence
<input type="number" id="essence" value="0">

Loisirs
<input type="number" id="loisirs" value="0">

Divers
<input type="number" id="divers" value="0">

Ã‰pargne du mois
<input type="number" id="epargneMois" value="300">

<button onclick="update()">Mettre Ã  jour</button>

<h4 id="totalDepenses"></h4>
<h4 id="reste"></h4>
<h4 id="cumul"></h4>

</div>

<div class="card">
<h3>ðŸŽ¯ Objectifs</h3>

<p>Fonds de sÃ©curitÃ© (6000â‚¬)</p>
<div class="progress">
  <div id="bar1" class="progress-bar"></div>
</div>

<p>Vacances (1500â‚¬)</p>
<div class="progress">
  <div id="bar2" class="progress-bar"></div>
</div>

<p>Projet perso (3000â‚¬)</p>
<div class="progress">
  <div id="bar3" class="progress-bar"></div>
</div>

</div>

<div class="card">
<h3>ðŸ“… Historique</h3>

<button onclick="sauvegardeAuto()">ðŸ’¾ Sauvegarder sur iCloud</button>

<label style="cursor:pointer;">
  ðŸ“¥ Restaurer depuis iCloud
  <input type="file"
         id="fileInput"
         accept=".json"
         onchange="handleImport(event)"
         style="display:none">
</label>

<label>Choisir un mois</label>
<input type="month" id="moisSelect">

<button onclick="ajouterMois()">Ajouter ce mois</button>

<table id="historiqueTable">
...
</table>

<canvas id="historyChart"></canvas>

</div>
<script>
  alert("JS chargÃ©");
let historique = JSON.parse(localStorage.getItem("historique")) || [];
let cumulTotal = 0;
let historyChart;

function initChart(){
    const ctx = document.getElementById("historyChart").getContext("2d");
    historyChart = new Chart(ctx,{
        type:"line",
        data:{
            labels:[],
            datasets:[
                {label:"DÃ©penses",data:[],borderColor:"#ef4444"},
                {label:"Ã‰pargne",data:[],borderColor:"#22c55e"}
            ]
        }
    });
}

function update(){
    const revenus = +revenus.value;
    const depenses = +charges.value + +courses.value + +essence.value + +loisirs.value + +divers.value;
    const epargne = +epargneMois.value;

    cumulTotal += epargne;

    totalDepenses.innerText = "Total DÃ©penses : " + depenses + " â‚¬";
    reste.innerText = "Reste : " + (revenus - depenses - epargne) + " â‚¬";
    cumul.innerText = "Ã‰pargne cumulÃ©e : " + cumulTotal + " â‚¬";
}

function ajouterMois(){

    const moisInput = document.getElementById("moisSelect").value;

    if(!moisInput){
        alert("Choisis un mois avant dâ€™ajouter.");
        return;
    }

    const [annee, mois] = moisInput.split("-");
    const moisFinal = mois + "/" + annee;

    const depenses =
        +charges.value +
        +courses.value +
        +essence.value +
        +loisirs.value +
        +divers.value;

    const epargne = +epargneMois.value;

    historique.push({mois: moisFinal, depenses, epargne});
    localStorage.setItem("historique", JSON.stringify(historique));

    afficherHistorique();
    majGraph();

    sauvegardeAuto();
}
function getEpargneTotale(){
    return historique.reduce((total, mois) => total + mois.epargne, 0);
}
function afficherHistorique(){
    const tbody = document.querySelector("#historiqueTable tbody");
    tbody.innerHTML="";
    historique.forEach((m,i)=>{
        tbody.innerHTML+=`
        <tr>
        <td>${m.mois}</td>
        <td>${m.depenses}â‚¬</td>
        <td>${m.epargne}â‚¬</td>
        <td><button onclick="supprimer(${i})" style="background:#ef4444">X</button></td>
        </tr>`;
    });
}
        
function supprimer(i){
    historique.splice(i,1);
    localStorage.setItem("historique",JSON.stringify(historique));
    afficherHistorique();
    majGraph();
  sauvegardeAuto();
}
function sauvegardeAuto(){
    alert("Sauvegarde dÃ©clenchÃ©e");

    const dataStr = "data:text/json;charset=utf-8," +
        encodeURIComponent(JSON.stringify({historique: historique}, null, 2));

    const a = document.createElement("a");
    a.setAttribute("href", dataStr);
    a.setAttribute("download", "sauvegarde_budget.json");

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
  function handleImport(e){

    const file = e.target.files[0];

    if(!file){
        alert("Aucun fichier dÃ©tectÃ©");
        return;
    }

    alert("Taille du fichier : " + file.size + " bytes");
}

  function restaurerDepuisIcloud(){
    document.getElementById("fileInput").click();
}
  
function updateObjectifs(){

    let total = getEpargneTotale();

    const objectif1 = 6000;  // SÃ©curitÃ©
    const objectif2 = 1500;  // Vacances
    const objectif3 = 3000;  // Projet

    // ---- SÃ©curitÃ© ----
    const securiteRempli = Math.min(total, objectif1);
    document.getElementById("bar1").style.width =
        (securiteRempli / objectif1) * 100 + "%";

    total -= securiteRempli;

    // ---- Vacances ----
    const vacancesRempli = Math.min(total, objectif2);
    document.getElementById("bar2").style.width =
        (vacancesRempli / objectif2) * 100 + "%";

    total -= vacancesRempli;

    // ---- Projet ----
    const projetRempli = Math.min(total, objectif3);
    document.getElementById("bar3").style.width =
        (projetRempli / objectif3) * 100 + "%";
}
window.onload = function(){
    initChart();
    afficherHistorique();
    majGraph();

};
</script>
</body>
</html>
