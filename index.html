<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Budget</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {font-family:-apple-system;background:#0f172a;color:white;padding:20px;}
.card {background:#1e293b;padding:15px;border-radius:16px;margin-bottom:20px;}
input {width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none;}
button {padding:10px;border:none;border-radius:8px;background:#22c55e;color:white;}
table {width:100%;margin-top:10px;border-collapse:collapse;}
th,td {padding:6px;text-align:center;}
.progress {background:#334155;border-radius:20px;height:15px;}
.progress-bar {height:100%;background:#22c55e;width:0%;}
</style>
</head>
<body>

<h1>üí∞ Mon Budget</h1>

<div class="card">
<h3>Budget</h3>

Revenus
<input type="number" id="revenus" value="1971">

Charges fixes
<input type="number" id="charges" value="812">

Courses
<input type="number" id="courses" value="0">

Essence
<input type="number" id="essence" value="0">

Loisirs
<input type="number" id="loisirs" value="0">

Divers
<input type="number" id="divers" value="0">

√âpargne du mois
<input type="number" id="epargneMois" value="300">

<button onclick="update()">Mettre √† jour</button>

<h4 id="totalDepenses"></h4>
<h4 id="reste"></h4>
<h4 id="cumul"></h4>

</div>

<div class="card">
<h3>üéØ Objectifs</h3>

<p>Fonds de s√©curit√© (6000‚Ç¨)</p>
<div class="progress">
  <div id="bar1" class="progress-bar"></div>
</div>

<p>Vacances (1500‚Ç¨)</p>
<div class="progress">
  <div id="bar2" class="progress-bar"></div>
</div>

<p>Projet perso (3000‚Ç¨)</p>
<div class="progress">
  <div id="bar3" class="progress-bar"></div>
</div>

</div>

<div class="card">
<h3>üìÖ Historique</h3>

<label>Choisir un mois</label>
<input type="month" id="moisSelect">

<button onclick="ajouterMois()">Ajouter ce mois</button>

<table id="historiqueTable">
<thead>
<tr>
<th>Mois</th>
<th>D√©penses</th>
<th>√âpargne</th>
<th>‚ùå</th>
</tr>
</thead>
<tbody></tbody>
</table>

<canvas id="historyChart" style="margin-top:20px;"></canvas>

</div>
<script>
let historique = JSON.parse(localStorage.getItem("historique")) || [];
let cumulTotal = 0;
let historyChart;

function initChart(){
    const ctx = document.getElementById("historyChart").getContext("2d");
    historyChart = new Chart(ctx,{
        type:"line",
        data:{
            labels:[],
            datasets:[
                {label:"D√©penses",data:[],borderColor:"#ef4444"},
                {label:"√âpargne",data:[],borderColor:"#22c55e"}
            ]
        }
    });
}

function update(){
    const revenus = +revenus.value;
    const depenses = +charges.value + +courses.value + +essence.value + +loisirs.value + +divers.value;
    const epargne = +epargneMois.value;

    cumulTotal += epargne;

    totalDepenses.innerText = "Total D√©penses : " + depenses + " ‚Ç¨";
    reste.innerText = "Reste : " + (revenus - depenses - epargne) + " ‚Ç¨";
    cumul.innerText = "√âpargne cumul√©e : " + cumulTotal + " ‚Ç¨";
}

function ajouterMois(){

    const moisInput = document.getElementById("moisSelect").value;

    if(!moisInput){
        alert("Choisis un mois avant d‚Äôajouter.");
        return;
    }

    const [annee, mois] = moisInput.split("-");
    const moisFinal = mois + "/" + annee;

    const depenses =
        +charges.value +
        +courses.value +
        +essence.value +
        +loisirs.value +
        +divers.value;

    const epargne = +epargneMois.value;

    historique.push({mois: moisFinal, depenses, epargne});
    localStorage.setItem("historique", JSON.stringify(historique));

    afficherHistorique();
    majGraph();

    sauvegardeAuto();
}
function getEpargneTotale(){
    return historique.reduce((total, mois) => total + mois.epargne, 0);
}
function afficherHistorique(){
    const tbody = document.querySelector("#historiqueTable tbody");
    tbody.innerHTML="";
    historique.forEach((m,i)=>{
        tbody.innerHTML+=`
        <tr>
        <td>${m.mois}</td>
        <td>${m.depenses}‚Ç¨</td>
        <td>${m.epargne}‚Ç¨</td>
        <td><button onclick="supprimer(${i})" style="background:#ef4444">X</button></td>
        </tr>`;
    });
}
        
function supprimer(i){
    historique.splice(i,1);
    localStorage.setItem("historique",JSON.stringify(historique));
    afficherHistorique();
    majGraph();
  sauvegardeAuto();
}
function sauvegardeAuto(){

    const data = {
        historique: historique
    };

    const blob = new Blob(
        [JSON.stringify(data, null, 2)],
        { type: "application/json" }
    );

    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "sauvegarde_budget_auto.json";

    document.body.appendChild(a); // n√©cessaire pour Safari
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url); // nettoyage
}
  console.log("Objectifs mis √† jour");
function updateObjectifs(){

    const total = getEpargneTotale();

    const objectif1 = 6000;
    const objectif2 = 1500;
    const objectif3 = 3000;

    document.getElementById("bar1").style.width =
        Math.min((total / objectif1) * 100, 100) + "%";

    document.getElementById("bar2").style.width =
        Math.min((total / objectif2) * 100, 100) + "%";

    document.getElementById("bar3").style.width =
        Math.min((total / objectif3) * 100, 100) + "%";
}  
function majGraph(){
    historyChart.data.labels = historique.map(m=>m.mois);
    historyChart.data.datasets[0].data = historique.map(m=>m.depenses);
    historyChart.data.datasets[1].data = historique.map(m=>m.epargne);
    historyChart.update();

    updateObjectifs();
}

function updateObjectifs(){

    let total = getEpargneTotale();

    const objectif1 = 6000;  // S√©curit√©
    const objectif2 = 1500;  // Vacances
    const objectif3 = 3000;  // Projet

    // ---- S√©curit√© ----
    const securiteRempli = Math.min(total, objectif1);
    document.getElementById("bar1").style.width =
        (securiteRempli / objectif1) * 100 + "%";

    total -= securiteRempli;

    // ---- Vacances ----
    const vacancesRempli = Math.min(total, objectif2);
    document.getElementById("bar2").style.width =
        (vacancesRempli / objectif2) * 100 + "%";

    total -= vacancesRempli;

    // ---- Projet ----
    const projetRempli = Math.min(total, objectif3);
    document.getElementById("bar3").style.width =
        (projetRempli / objectif3) * 100 + "%";
}
window.onload = function(){
    initChart();
    afficherHistorique();
    majGraph();
}
</script>

</body>
</html>
